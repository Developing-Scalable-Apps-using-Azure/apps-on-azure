/*
Deployment script for sbazuresqldb221936360

This code was generated by a tool.
Changes to this file may cause incorrect behavior and will be lost if
the code is regenerated.
*/

GO
SET ANSI_NULLS, ANSI_PADDING, ANSI_WARNINGS, ARITHABORT, CONCAT_NULL_YIELDS_NULL, QUOTED_IDENTIFIER ON;

SET NUMERIC_ROUNDABORT OFF;


GO
:setvar DatabaseName "sbazuresqldb221936360"
:setvar DefaultFilePrefix "sbazuresqldb221936360"
:setvar DefaultDataPath ""
:setvar DefaultLogPath ""

GO
:on error exit
GO
/*
Detect SQLCMD mode and disable script execution if SQLCMD mode is not supported.
To re-enable the script after enabling SQLCMD mode, execute the following:
SET NOEXEC OFF; 
*/
:setvar __IsSqlCmdEnabled "True"
GO
IF N'$(__IsSqlCmdEnabled)' NOT LIKE N'True'
    BEGIN
        PRINT N'SQLCMD mode must be enabled to successfully execute this script.';
        SET NOEXEC ON;
    END


GO
IF EXISTS (SELECT 1
           FROM   [sys].[databases]
           WHERE  [name] = N'$(DatabaseName)')
    BEGIN
        ALTER DATABASE [$(DatabaseName)]
            SET ANSI_NULLS ON,
                ANSI_PADDING ON,
                ANSI_WARNINGS ON,
                ARITHABORT ON,
                CONCAT_NULL_YIELDS_NULL ON,
                QUOTED_IDENTIFIER ON,
                ANSI_NULL_DEFAULT ON 
            WITH ROLLBACK IMMEDIATE;
    END


GO
IF EXISTS (SELECT 1
           FROM   [sys].[databases]
           WHERE  [name] = N'$(DatabaseName)')
    BEGIN
        ALTER DATABASE [$(DatabaseName)]
            SET ALLOW_SNAPSHOT_ISOLATION OFF;
    END


GO
IF EXISTS (SELECT 1
           FROM   [sys].[databases]
           WHERE  [name] = N'$(DatabaseName)')
    BEGIN
        ALTER DATABASE [$(DatabaseName)]
            SET QUERY_STORE (QUERY_CAPTURE_MODE = ALL, CLEANUP_POLICY = (STALE_QUERY_THRESHOLD_DAYS = 367), MAX_STORAGE_SIZE_MB = 100) 
            WITH ROLLBACK IMMEDIATE;
    END


GO
IF EXISTS (SELECT 1
           FROM   [sys].[databases]
           WHERE  [name] = N'$(DatabaseName)')
    BEGIN
        ALTER DATABASE [$(DatabaseName)]
            SET QUERY_STORE = OFF 
            WITH ROLLBACK IMMEDIATE;
    END


GO
IF EXISTS (SELECT 1
           FROM   [sys].[databases]
           WHERE  [name] = N'$(DatabaseName)')
    BEGIN
        ALTER DATABASE SCOPED CONFIGURATION SET MAXDOP = 0;
    END


GO
IF EXISTS (SELECT 1
           FROM   [sys].[databases]
           WHERE  [name] = N'$(DatabaseName)')
    BEGIN
        ALTER DATABASE [$(DatabaseName)]
            SET TEMPORAL_HISTORY_RETENTION OFF 
            WITH ROLLBACK IMMEDIATE;
    END


GO
PRINT N'Creating Table [dbo].[Cookies]...';


GO
CREATE TABLE [dbo].[Cookies] (
    [Id]       INT            IDENTITY (1, 1) NOT NULL,
    [Name]     VARCHAR (50)   NULL,
    [ImageUrl] NVARCHAR (150) NULL,
    [Price]    FLOAT (53)     NULL,
    PRIMARY KEY CLUSTERED ([Id] ASC)
);


GO
PRINT N'Creating Table [dbo].[OrderLines]...';


GO
CREATE TABLE [dbo].[OrderLines] (
    [Id]       INT IDENTITY (1, 1) NOT NULL,
    [Quantity] INT NULL,
    [CookieId] INT NULL,
    [OrderId]  INT NULL,
    PRIMARY KEY CLUSTERED ([Id] ASC)
);


GO
PRINT N'Creating Table [dbo].[Orders]...';


GO
CREATE TABLE [dbo].[Orders] (
    [Id]      INT                IDENTITY (1, 1) NOT NULL,
    [Date]    DATETIMEOFFSET (7) NULL,
    [Price]   FLOAT (53)         NULL,
    [Status]  NVARCHAR (150)     NULL,
    [StoreId] INT                NULL,
    PRIMARY KEY CLUSTERED ([Id] ASC)
);


GO
PRINT N'Creating Table [dbo].[Stores]...';


GO
CREATE TABLE [dbo].[Stores] (
    [Id]      INT          IDENTITY (1, 1) NOT NULL,
    [Name]    VARCHAR (50) NULL,
    [Country] VARCHAR (50) NULL,
    PRIMARY KEY CLUSTERED ([Id] ASC)
);


GO
PRINT N'Creating Foreign Key [dbo].[CookieForeignKey]...';


GO
ALTER TABLE [dbo].[OrderLines] WITH NOCHECK
    ADD CONSTRAINT [CookieForeignKey] FOREIGN KEY ([CookieId]) REFERENCES [dbo].[Cookies] ([Id]);


GO
PRINT N'Creating Foreign Key [dbo].[OrderForeignKey]...';


GO
ALTER TABLE [dbo].[OrderLines] WITH NOCHECK
    ADD CONSTRAINT [OrderForeignKey] FOREIGN KEY ([OrderId]) REFERENCES [dbo].[Orders] ([Id]) ON DELETE CASCADE;


GO
PRINT N'Creating Foreign Key [dbo].[StoreForeignKey]...';


GO
ALTER TABLE [dbo].[Orders] WITH NOCHECK
    ADD CONSTRAINT [StoreForeignKey] FOREIGN KEY ([StoreId]) REFERENCES [dbo].[Stores] ([Id]);


GO

if not exists(select 1 from dbo.stores) 
BEGIN

--INSERT INTO dbo.DatabaseServers(DatabaseServer, DatabaseName, Region) values ('internationalcookiesq2bpnesdylzbk.database.windows.net', 'internationalcookies-db-we', 'WE')
--INSERT INTO dbo.DatabaseServers(DatabaseServer, DatabaseName, Region) values ('internationalcookiesq2bpneshskdj.database.windows.net', 'internationalcookies-db-bs', 'BS')
--INSERT INTO dbo.DatabaseServers(DatabaseServer, DatabaseName, Region) values ('internationalcookiesq2bpnesdjkhf.database.windows.net', 'internationalcookies-db-cus', 'CUS')
--INSERT INTO dbo.DatabaseServers(DatabaseServer, DatabaseName, Region) values ('internationalcookiesq2bppqoeyns.database.windows.net', 'internationalcookies-db-sea', 'SEA')


INSERT INTO dbo.cookies (ImageUrl, [Name], Price) values ('https://ibcdnep01.azureedge.net/cookie-cc.jpg', 'Chololate Chip', 1.2)
INSERT INTO dbo.cookies (ImageUrl, [Name], Price) values ('https://ibcdnep01.azureedge.net/cookie-bc.jpg', 'Butter Cookie', 1.0)
INSERT INTO dbo.cookies (ImageUrl, [Name], Price) values ('https://ibcdnep01.azureedge.net/cdn/cookie-mc.jpg', 'Macaroons', 0.9)

INSERT INTO dbo.stores (Country, [Name]) values ('Netherlands', 'Holland Cookies')
INSERT INTO dbo.stores (Country, [Name]) values ('United States', 'Excellent Cookies')
INSERT INTO dbo.stores (Country, [Name]) values ('Brazil', 'Yummie Cookies')
INSERT INTO dbo.stores (Country, [Name]) values ('Singapore', 'Lovely Cookies')

INSERT INTO dbo.[Orders] ([Date], Price, StoreId) values ('2022-01-15', 20, 1)
INSERT INTO dbo.[OrderLines] (CookieId, OrderId, Quantity) values (1, 1, 3)


END
GO

GO
